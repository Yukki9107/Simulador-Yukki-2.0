{% extends "base.html" %}

{% block title %}Resultados · {{ module_cfg.name }}{% endblock %}

{% block content %}
<section class="results-card">
    <header>
        <h1>Resultados · {{ module_cfg.name }}</h1>
        <p class="results-summary">
            <div class="results-actions" style="margin: 12px 0 14px; display:flex; gap:10px; flex-wrap:wrap;">
  <button class="btn primary" id="ai-analyze-btn" type="button">Analizar con IA</button>
</div>

<div id="ai-analysis-box" class="result-item" style="display:none;">
  <p class="result-question"><strong>Diagnóstico del asistente</strong></p>
  <pre id="ai-analysis-text" style="white-space: pre-wrap; margin:0;"></pre>
</div>

<script>
(function () {
  const analyzeBtn = document.getElementById("ai-analyze-btn");
  const analysisBox = document.getElementById("ai-analysis-box");
  const analysisText = document.getElementById("ai-analysis-text");

  if (!analyzeBtn) return;

  analyzeBtn.addEventListener("click", async () => {
    analyzeBtn.disabled = true;
    analyzeBtn.textContent = "Analizando...";

    try {
      const res = await fetch("/ai/analyze", { method: "POST" });
      const data = await res.json();

      analysisBox.style.display = "block";
      analysisText.textContent = data.analysis || data.error || "Sin respuesta.";
    } catch (e) {
      analysisBox.style.display = "block";
      analysisText.textContent = "Error llamando a IA: " + e;
    } finally {
      analyzeBtn.disabled = false;
      analyzeBtn.textContent = "Analizar con IA";
    }
  });
})();
</script>

            Aciertos: <strong>{{ correct_count }}</strong> de <strong>{{ total }}</strong> reactivos.
            Calificación aproximada: <strong>{{ percentage }}%</strong>.
        </p>
        <div class="results-actions">
            <a href="{{ url_for('exam', module_key=module_cfg|attr('key') if false else request.args.get('module_key', '') ) }}" class="btn ghost">
                <!-- pequeño truco para no romper: usaremos solo el botón de inicio -->
            </a>
            <a href="{{ url_for('reset') }}" class="btn primary">Nuevo simulacro</a>
            <a href="{{ url_for('index') }}" class="btn secondary">Volver al inicio</a>
        </div>
    </header>

    <section class="results-list">
        {% for item in details %}
        <article class="result-item">
            <p class="result-question">
                {{ loop.index }}. {{ item.text }}
                {% if item.is_correct %}
                    <span class="badge correct">Correcta</span>
                {% else %}
                    <span class="badge incorrect">Incorrecta</span>
                {% endif %}
            </p>
            <p class="result-answer">
                Tu respuesta:
                {% if item.selected_index is not none %}
                    {{ item.options[item.selected_index] }}
                {% else %}
                    <em>Sin responder</em>
                {% endif %}
            </p>
            <p class="result-answer">
                Respuesta correcta:
                <strong>{{ item.options[item.correct_index] }}</strong>
            </p>
            {% if item.explanation %}
            <p class="result-explanation">
                {{ item.explanation }}
            </p>
            {% endif %}
        </article>
        {% endfor %}
    </section>
</section>
{% endblock %}
